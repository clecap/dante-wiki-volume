const buildRegex=e=>new RegExp("\\[\\[\\s*Category\\s*\\:\\s*"+e+"\\s*\\]\\]","g"),removeTextCategory=(e,t)=>e.replace(buildRegex(t),""),addTextCategory=(e,t)=>e.trimEnd()+"\n[[Category:"+t+"]]",hasTextCategory=(e,t)=>buildRegex(t).test(e);function promiseGetContent(e){return new Promise(((t,n)=>{const i={action:"query",prop:"revisions",titles:e,rvslot:"*",rvprop:"content",formatversion:2};(new mw.Api).get(i).done((function(e){t(e)}))}))}function promiseStoreText(e){return new Promise(((t,n)=>{var i={action:"edit",title:mw.config.get("wgPageName"),text:e,format:"json",summary:"Automated change: Category Edit by TreeAndMenu new generation, file: fanytree.js"};(new mw.Api).postWithToken("csrf",i).done((function(e){console.log("promiseStoreText received: ",JSON.stringify(e)),t()}))}))}async function addCat(e){var t,n=(await promiseGetContent(mw.config.get("wgPageName"))).query.pages[0].revisions[0].content;t=e,n=n.trimEnd()+"\n[[Category:"+t+"]]",await promiseStoreText(n),window.location.reload()}async function delCat(e){var t,n=(await promiseGetContent(mw.config.get("wgPageName"))).query.pages[0].revisions[0].content;t=e,n=n.replace(buildRegex(t),""),await promiseStoreText(n),window.location.reload()}var catWindow=null;function persistCatWindow(e){e.preventDefault();var t=null;if("newWin"==window.name)t=window;else{if(!catWindow||catWindow.closed)return void console.log("ignoring persistCatwindow from Mediawiki TreeAndMenu as there is no current cat window or it is closed");t=catWindow}var n=t.outerWidth,i=t.outerHeight,o=t.screenX,a=t.screenY;localStorage.setItem("catWidth",n),localStorage.setItem("catHeight",i),localStorage.setItem("catLeft",o),localStorage.setItem("catTop",a),console.log(`TreeAndMenu:fancytrees.js:persistCatWindow persisted ${n} and ${i} and ${o} and ${a}`)}function getPersistCatWindow(){var e=localStorage.getItem("catWidth");e=parseInt(e),console.log("w",e),isNaN(e)&&(e=window.screen.availWidth/5);var t=localStorage.getItem("catHeight");t=parseInt(t),console.log("h",t),isNaN(t)&&(t=window.screen.availHeight);var n=localStorage.getItem("catLeft");n=parseInt(n),console.log("l",n),isNaN(n)&&(n=0);var i=localStorage.getItem("catTop");return i=parseInt(i),console.log("t",i),isNaN(i)&&(i=0),{width:e,height:t,left:n,top:i}}function openCategories(e,t){e.visit((e=>{e.setSelected(!1)})),e.visit((function(e){for(var n=0;n<t.length;n++)if(-1!=e.title.indexOf(">"+t[n]+"<")){e.setSelected(!0);var i=e.parent;do{i.setExpanded(!0)}while(i=i.parent);break}}))}function promiseGetCat(e){return new Promise(((t,n)=>{const i={action:"query",format:"json",prop:"categories",titles:e};(new mw.Api).get(i).done((function(e){var i,o=e.query.pages,a=Object.keys(o).length;a>1&&n("More than one page found: "+a);var s=[];for(i in o)o[i].categories&&o[i].categories.forEach((function(e){console.log("Has category: "+e.title),s.push(e.title)}));t(s)}))}))}function instrumentCatCheckBoxes(){document.body.classList.contains("action-edit")&&$("span.fancytree-checkbox").not(".fancytree-is-instrumented").each(((e,t)=>{t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),alert("Please do not edit categories in the Edit mode of a page. Do so in Read mode. There is a good reason for this design decision.")}))})).addClass("fancytree-is-instrumented"),document.body.classList.contains("action-view")&&$("span.fancytree-checkbox").not(".fancytree-is-instrumented").each(((e,t)=>{t.addEventListener("click",(e=>{var t=e.target.parentNode.classList.contains("fancytree-selected"),n=e.target.nextSibling.textContent;console.log("flag: ",t,"cat",n),t?delCat(n):addCat(n)}))})).addClass("fancytree-is-instrumented")}window.openAsPopup=function(e){e.preventDefault();var t=getPersistCatWindow();(catWindow=window.open(e.target.href,"newWin","width="+t.width+", height="+t.height)).moveTo(t.left,t.top)};var treeRegister=[];function adjustToPersistence(e){"close"==localStorage.getItem(e)?$("#switcher-"+e+"-label").addClass("img-negative").parent().siblings(":first").hide():$("#switcher-"+e+"-label").removeClass("img-negative").parent().siblings(":first").show()}window.prepareTAMX=function(e){var t;return $((e?"#"+e:"")+" .fancytree.todo").each((function(n,i){i.classList.remove("todo");var o,a={},s=$("div.opts",$(i));s.length>0&&(o=$.parseJSON(s.text())),Object.assign(a,o),void 0===a.extensions&&(a.extensions=["mediawiki"]),a.extensions.includes("mediawiki")||a.extensions.push("mediawiki"),"p-catus"==e&&(a.extensions=["persist"],a.checkbox=!0,a.icons=!1),a.toggleEffect=!1,"false"==a.icons&&(a.icons=!1),a.activeVisible=!0,a.dblclick=(e,t)=>{e.preventDefault(),e.stopPropagation()},t=$(i).fancytree(a),treeRegister.push({tree:t,options:{toggleEffect:{effect:"blind",options:{direction:"vertical",scale:"box"},duration:200}}})})),$(".suckerfish.todo").each((function(){$(this).removeClass("todo"),$("li",this).each((function(){var e=$(this);e.addClass(1&e.index()?"odd":"even")}))})),"p-catus"==e&&(instrumentCatCheckBoxes(),$("#p-catus").click((e=>{instrumentCatCheckBoxes()}))),t};const installSidebarScroll=()=>{$("#mw-panel").scroll((()=>{localStorage.setItem("panelScroll",$("#mw-panel").scrollTop())}))},installPortletToggle=()=>{const e=e=>{var t="open"==localStorage.getItem(e)?"close":"open";localStorage.setItem(e,t),console.log("found: ","#switcher-"+e+"-label",$("#switcher-"+e+"-label").length),$("#switcher-"+e+"-label").toggleClass("img-negative").parent().siblings(":first").slideToggle(200)};$(".img-switcher").click((t=>{e(t.target.parentNode.parentNode.id),t.stopPropagation()})),$(".img-switcher").parents(".vector-menu-heading").click((t=>{var n=t.currentTarget.id;n=n.substring(0,n.length-6),e(n),t.stopPropagation()}))},installPropagate=()=>{$(".fancytree-icon").each(((e,t)=>{t.parentNode.classList.contains("fancytree-has-children")&&(t.classList.add("clickable-icon"),$(t).click((()=>{$(t.previousElementSibling).click()})))})),$(".fancytree-title").each(((e,t)=>{t.parentNode.classList.contains("fancytree-has-children")&&($(t).children("a").length||$(t).click((()=>{console.log("saw a click on title without anchor element"),$(t.previousElementSibling).click()})))}))},logoPatcher=()=>{const e=document.getElementById("p-logo");e.innerHTML="";var t=document.createElement("span");t.innerHTML=mw.config.get("wgSiteName"),t.className="personal-wiki-name-logo",t.setAttribute("title","Name of the specific dantewiki to distinguish multiple variants"),e.appendChild(t)};!function(){var e=[],t="zero-timeout-message";window.addEventListener("message",(function(n){n.source==window&&n.data==t&&(n.stopPropagation(),e.length>0&&e.shift()())}),!0),window.setZeroTimeout=function(n){e.push(n),window.postMessage(t,"*")}}();const patchPortletHeaders=()=>{$("#mw-panel").find("label").each(((e,t)=>{console.log("TreeAndMenu: patchPortletHeaders: ",t.id),$(t).prepend("<span class='img-switcher' id='switcher-"+t.id+"'></span>")}))},patchMagicLinks=()=>{};window.initializeCatTree=()=>{const e=document.getElementById("p-catus-label");e&&(e.innerHTML="<span data-fixi> Categories</span>");const t=prepareTAMX("p-catus");if(t){var n=mw.config.get("wgCategories");openCategories(t.fancytree("getTree"),n),t.fancytree("option","toggleEffect",{effect:"blind",options:{direction:"vertical",scale:"box"},duration:200}),instrumentCatCheckBoxes(),document.getElementById("sidebar-cattree").style.display="block"}};var sidebarIsPatched=!1;function patchSidebar(){sidebarIsPatched?console.info("fancytree.js: sidebar is already patched"):(initializeCatTree(),$("#mw-panel").find("label").each(((e,t)=>{console.log("TreeAndMenu: patchPortletHeaders: ",t.id),$(t).prepend("<span class='img-switcher' id='switcher-"+t.id+"'></span>")})),prepareTAMX(),$("#mw-panel").show(),$("#mw-panel").scrollTop(localStorage.getItem("panelScroll")),$(".mw-portlet").each(((e,t)=>{adjustToPersistence(t.id)})),sidebarIsPatched=!0,window.setZeroTimeout((()=>{treeRegister.forEach((e=>{for(var t in e.options)e.tree.fancytree("option",t,e.options[t])})),$("#mw-panel").scroll((()=>{localStorage.setItem("panelScroll",$("#mw-panel").scrollTop())})),installPortletToggle(),$(".fancytree-icon").each(((e,t)=>{t.parentNode.classList.contains("fancytree-has-children")&&(t.classList.add("clickable-icon"),$(t).click((()=>{$(t.previousElementSibling).click()})))})),$(".fancytree-title").each(((e,t)=>{t.parentNode.classList.contains("fancytree-has-children")&&($(t).children("a").length||$(t).click((()=>{console.log("saw a click on title without anchor element"),$(t.previousElementSibling).click()})))}))})))}patchSidebar(),$(document).ready(patchSidebar);
function b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})))}const PROCESS=(()=>{let e,t,n=!1,o=null;return{process:i=>{"INIT"==i?console.info("preview.js: process called at initialization "):"RESIZE"==i?console.info("preview.js: process called after resize"):i instanceof InputEvent?console.info("preview.js: process called after InputEvent ","type=",i.inputType,i.isComposing?" COMPOSING ":" NOT_COMPOSING","data=",i.data,i):console.error("preview.js process called in unclear situation");if("INIT"==i||"RESIZE"==i||["insertFromDrop","insertFromPaste","insertFromPasteAsQuotation","deleteByDrag","deleteByCut","historyUndo","historyRedo"].includes(i.inputType))return console.info("CASE 1: Special request with immediate processing: "+("string"==typeof i?i:i.inputType)),void e();if(n){if(i.timeStamp-t>1e3)return console.info(`CASE 2: ${i.timeStamp} ${t}`),o&&(window.clearTimeout(o),o=null),n=!1,void e();console.info(`CASE 2-: Not yet time to execute a call: current=${i.timeStamp} oldestUnserved=${t}  diff=${i.timeStamp-t}`)}else n=!0,t=i.timeStamp,console.info("CASE 3a: Setting up a timeout event"),o=window.setTimeout((()=>{console.info("CASE 3b: Timeout fired"),n=!1,e()}),1100)},setFct:t=>{e=t}}})(),DPRES=(()=>{function e(e){if(200!=e.target.status)return console.warn(`DantePresentations: preview: Received an ERROR message from an endpoint. Status Code=${e.target.status} Status Text=${e.target.statusText});`),void(confirm(`Server Error: Status Code ${e.target.status} ${e.target.statusText} \nURL: ${e.target.responseURL}\nConfirm to open more detailed error window`)&&window.open(e.target.responseURL,"_blank"));console.info(`DantePresentations: preview: Received an endpoint response with status Code=${e.target.status}`),e.target.timeRequestMade?e.target.timeRequestMade>QUEUE.currentTimestamp?(console.log("  Will display the endpoint response"),function(e){let t=!0;t&&console.log("displayEndpointResponse called");var n=document.getElementById("previewFrame");document.getElementById("previewFrame").setAttribute("srcdoc",e.target.response),document.getElementById("previewFrame").style.visibility="visible",QUEUE.currentTimestamp=e.target.timeRequestMade,QUEUE.remove(e.target),QUEUE.nonCancelable(),0==QUEUE.getLen()&&document.body.classList.remove("xhrPending");document.getElementById("previewFrame").onload=function(){document.getElementById("previewFrame").contentWindow.addEventListener("focus",(e=>{console.warn("FOCUS"),n.classList.add("hasFocus")})),document.getElementById("previewFrame").contentWindow.addEventListener("blur",(e=>{console.warn("BLUR"),n.classList.remove("hasFocus")})),document.getElementById("previewFrame").contentWindow.document.addEventListener("keydown",(e=>{if(console.log("Key pressed: ",e.key),e.metaKey&&("+"==e.key||"-"==e.key)){e.preventDefault(),e.stopPropagation();var t=parseFloat(n.contentWindow.document.body.style.zoom);t=isNaN(t)?1:t,console.log("zoomIs found:",t,n.contentWindow.document.body.style.zoom),console.log("active ",document.activeElement);let o=t*("+"==e.key?1.2:.8);n.contentWindow.document.body.style.zoom=o}}))},t&&console.log("will exit displayEndpointResponse, queue is ",QUEUE.getLen());QUEUE.getLen()>0&&console.warn("will exit displayEndpointResponse, queue still is ",QUEUE.getLen())}(e)):(console.log(`  Will discard endpoint response. Tool old: From ${e.target.timeRequestMade} and thus older than current status ${QUEUE.currentTimestamp}`),QUEUE.remove(e.target)):console.warn("  The XHR object had no timestamp, this is a protocol error!")}function t(){console.warn("processAll called ******************************************"),console.warn("RLCONF is: ",RLCONF);var t=b64EncodeUnicode(document.getElementById("wpTextbox1").value);const n=new XMLHttpRequest;n.open("POST","./extensions/DantePresentations/endpoints/mediawikiEndpoint.php",!0),n.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),n.setRequestHeader("Wiki-wgUserName",RLCONF.wgUserName),n.setRequestHeader("Wiki-wgUserId",RLCONF.wgUserId),n.setRequestHeader("Wiki-wgNamespaceNumber",RLCONF.wgNamespaceNumber),n.setRequestHeader("Wiki-wgPageName",RLCONF.wgPageName),n.setRequestHeader("Wiki-wgTitle",RLCONF.wgTitle),n.setRequestHeader("Wiki-wpPageContentLanguage",RLCONF.wgPageContentLanguage),n.timeRequestMade=Date.now(),n.setRequestHeader("X-Dante-ClientRequestTime",n.timeRequestMade),n.onload=t=>{e(t)},QUEUE.submit(n),document.body.classList.add("xhrPending"),n.send(t)}return{editPreviewPatch:function(){console.error("------------------------DANTEPRESENTATIONS: editPreviewPatch"),function(){console.warn("DantePresentations:preview.js: initializeTextarea");var e=document.getElementById("wpTextbox1");const n=()=>{document.getElementById("textarea-wrapper"),shouldReset=!0,console.log("preview.js: resize observer storing textarea dimensions "),window.localStorage.setItem("textareaWidth",Math.max(100,e.offsetWidth)),window.localStorage.setItem("textareaHeight",Math.max(100,e.offsetHeight)),waitBeforeInvoke(300)};new ResizeObserver(n).observe(e),new ResizeObserver(n).observe(document.body),Object.assign(e.style,{minWidth:"150px",resize:"both",display:"inline-block"}),window.localStorage.getItem("textareaWidth")&&(e.style.width=window.localStorage.getItem("textareaWidth")+"px"),window.localStorage.getItem("textareaHeight")&&(e.style.height=window.localStorage.getItem("textareaHeight")+"px"),e.myFontSize=14,e.style.fontSize=e.myFontSize+"pt",e.addEventListener("keydown",(t=>{!t.metaKey||"+"!=t.key&&"-"!=t.key||(t.preventDefault(),t.stopPropagation(),e.myFontSize+="+"==t.key?2:-2,e.style.fontSize=e.myFontSize+"pt")}));var o=document.createElement("div");o.id="new-edit-container",Object.assign(o.style,{display:"flex"}),e.parentNode.replaceChild(o,e),o.appendChild(e);var i=document.createElement("div");i.id="inline-edit-preview-container",Object.assign(i.style,{minWidth:"18px",display:"inline-block",flex:"1 1 auto","box-sizing":"border-box",position:"relative"});var s=document.createElement("img");s.id="previewImage",Object.assign(s.style,{width:"100%",height:"100%",position:"absolute",border:"0px solid yellow",left:"0px",top:"0px"});var a=document.createElement("iframe");a.id="previewFrame",Object.assign(a.style,{width:"100%",height:"100%",position:"absolute",left:"0px",top:"0px"}),s.style.visibility=a.style.visibility="hidden",i.appendChild(s),i.appendChild(a),o.appendChild(i);let r=document.getElementById("editform");PROCESS.setFct(t),r.addEventListener("input",PROCESS.process),window.setTimeout((()=>{PROCESS.process("INIT")}),0)}()}}})();window.editPreviewPatch=DPRES.editPreviewPatch;var QUEUE=(()=>{let e=[];var t=()=>{e=e.filter((e=>!!e.nonCancelable||(e.abort(),!1)))};return{submit:t=>{e.unshift(t)},nonCancelable:()=>{e.length>0&&(e[0].nonCancelable=!0,t())},currentTimestamp:0,getLen:()=>e.length,remove:t=>{e=e.filter((e=>e!=t))}}})(),timer=null;function waitBeforeInvoke(e){window.clearTimeout(timer),timer=window.setTimeout((()=>PROCESS.process("RESIZE")),e)}